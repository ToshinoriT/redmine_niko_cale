<%
# Niko-cale plugin for Redmine
# Copyright (C) 2010  Yuki Kita
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
%>

<div id="niko_niko_calender" style="overflow-x:auto">
<table border="1">
  <tr>
    <th rowspan="3" nowrap width="10%">
      <%= previous_image(l(:label_previous), 'document.forms["scope"].date_scope.value = "' + (@dates.first - 1).to_s + '"') %>
      <%= next_image(l(:label_next), 'document.forms["scope"].date_scope.value = "' + (@dates.last + @dates.size).to_s + '"') %>
    </th>
    <% if @dates.first.year == @dates.last.year %>
      <th colspan=<%= "\"#{@dates.size}\"" %>><%= @dates.first.year %></th>
    <% else %>
      <th colspan=<%= "\"#{@dates.first.end_of_year - @dates.first + 1}\"" %>><%= @dates.first.year %></th>
      <% unless @dates.first.month == @dates.last.month %>
        <th colspan=<%= "\"#{@dates.last - @dates.first.end_of_year + 1}\"" %>><%= @dates.last.year %></th>
      <% end %>
    <% end %>
  </tr>
  <tr>
    <th colspan=<%= "\"#{@dates.first.end_of_month - @dates.first + 1}\"" %>><%= @dates.first.month %></th>
    <% unless @dates.first.month == @dates.last.month %>
      <th colspan=<%= "\"#{@dates.last - @dates.first.end_of_month + 1}\"" %>><%= @dates.last.month %></th>
    <% end %>
  </tr>
  <tr>
    <% @dates.each do |date| %>
      <th class=date>
        <%= link_to(format_date_with_color(date), :controller=>:projects, :action=>:activity, :id=>@project, :from=>date) %>
        <% version = @versions.find {|version| version.effective_date == date} %>
        <% if version %>
          <%= link_to with_baloon(version_image, version.name), {:controller=>:versions, :action=>:show, :id=>version.id} %>       
        <% end %>
      </th>
    <% end %>
  </tr>
  <% @users.each do |user| %>
  <tr> 
    <td nowrap class=user>
       <p><%= link_to_feeling_list(:user=>user, :title=>user.name) %></p>
       <p><%= link_to_issues_list "(#{@issues_count_per_user[user]})", user.id %></p>
    </td> 
    <% @dates.each do |date| %>
      <% feeling = @feelings_per_user[user].find {|feeling| feeling.at == date} %>
      <td <%= (date == Date.today) ? 'class=today' : "" %>>
        <% if feeling.nil? && editable?(Feeling.for(user, date)) && @project.users.include?(user) %>
	  <%= link_to add_image, {:controller=>:feelings, :action=>:new, :date=>date, :project_id=>@project.identifier} %>
	<% else %>
          <%= link_to_feeling(feeling, @project.identifier) %>
	<% end %>
      </td>
    <% end %>
  </tr> 
  <% end %>
  <% unless @morales.empty? %>
  <tr>
    <td class=morale><%= link_to_feeling_list(:project=>@project, :title=>@project.name) %>
    <br><%= link_to_issues_list "(#{@issues_count_per_user[:morale]})", nil %><br></td> 
    <% @dates.each do |date| %>
      <% morale = @morales.find {|m| m.at == date} %>
      <td class=morale><%= image_for(morale) %></td>
    <% end %>
  </tr>
  <% end %>
</table>
</div>
